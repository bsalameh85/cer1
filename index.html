<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Ù†Ø¸Ø§Ù… Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script type="text/javascript">
    (function() {
      // ØªÙ… ØªØ­Ø¯ÙŠØ« Public Key Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§
      emailjs.init({
        publicKey: "pyfwfXQk621NyRfEn", 
      });
    })();
  </script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      direction: rtl;
      padding: 40px;
      background-color: #f4f4f4;
    }
    h1 {
      text-align: center;
    }
    .tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
      flex-wrap: nowrap;
    }
    .tabs button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 25px;
      font-size: 16px;
      border-radius: 10px 10px 0 0;
      cursor: pointer;
      flex: 1;
      max-width: 200px;
      white-space: nowrap;
      transition: background-color 0.3s;
    }
    .tabs button.active {
      background: #0056b3;
    }
    .tab-content {
      display: none;
      background: #fff;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      max-width: 800px;
      margin: auto;
    }
    .tab-content.active {
      display: block;
    }
    input[type="file"], button.submit, button.export-btn, button.send-all-emails-btn {
      margin: 20px 5px; /* Adjust margin for multiple buttons */
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 8px;
      border: none;
    }
    button.submit {
      background: #28a745;
      color: white;
    }
    button.export-btn {
      background: #007bff;
      color: white;
    }
    button.send-all-emails-btn { /* Style for the new button */        
        background-color: #6f42c1; /* Purple color */        
        color: white;    
    }
    button.send-all-emails-btn:hover {        
        background-color: #5a3597;    
    }
    .certificates {      
        display: flex;      
        flex-direction: column;      
        align-items: center;    
    }
    .certificate {      
        width: 800px;      
        height: 500px;      
        border: 4px solid #333;      
        background: white;      
        margin: 20px 0;      
        padding: 30px;      
        text-align: center;      
        position: relative;      
        box-sizing: border-box;      
        display: flex;      
        flex-direction: column;      
        justify-content: space-between;    
    }
    .certificate-header h1 {      
        font-size: 28px;      
        margin-bottom: 10px;    
    }
    .certificate-body {        
        flex-grow: 1;        
        display: flex;        
        flex-direction: column;        
        justify-content: center;        
        align-items: center;    
    }
    .certificate-body h2 {      
        font-size: 24px;      
        margin: 10px 0;    
    }
    .certificate-body p {      
        font-size: 18px;      
        margin: 5px 0;    
    }
    .footer {      
        position: relative;      
        bottom: 0;      
        left: 0;      
        right: 0;      
        display: flex;      
        justify-content: space-between;      
        font-size: 16px;      
        padding-top: 20px;    
    }
    .certificate-actions {      
        text-align: center;      
        margin-top: 10px;    
    }
    .certificate-actions button {      
        padding: 8px 15px;      
        margin: 5px;      
        border-radius: 6px;      
        border: none;      
        cursor: pointer;      
        font-size: 15px;      
        transition: background-color 0.3s;    
    }
    .certificate-actions .send-email-btn {      
        background-color: #ffc107;      
        color: #212529;    
    }
    .certificate-actions .send-email-btn:hover {      
        background-color: #e0a800;    
    }
    .certificate-actions .print-btn {        
        background-color: #17a2b8; /* Info blue color */        
        color: white;    
    }
    .certificate-actions .print-btn:hover {        
        background-color: #138496;    
    }
    table {      
        width: 100%;      
        border-collapse: collapse;      
        margin-top: 20px;    
    }
    table, th, td {      
        border: 2px solid #007bff;    
    }
    th, td {      
        padding: 10px;      
        text-align: center;      
        font-size: 16px;    
    }
    th {      
        background-color: #007bff;      
        color: white;    
    }
    button.edit-btn {      
        background-color: #ffc107;      
        border: none;      
        padding: 6px 14px;      
        border-radius: 6px;      
        cursor: pointer;      
        color: #212529;      
        font-weight: bold;      
        transition: background-color 0.3s;    
    }
    button.edit-btn:hover {      
        background-color: #e0a800;    
    }
    #courseSelect {      
        width: 100%;      
        max-width: 400px;      
        padding: 10px 15px;      
        font-size: 16px;      
        border: 2px solid #007bff;      
        border-radius: 8px;      
        outline: none;      
        box-sizing: border-box;      
        margin-bottom: 20px;      
        appearance: none;      
        background-color: #fff;      
        cursor: pointer;    
    }
    #uploadTab label[for="courseSelect"] {      
        font-weight: bold;      
        margin-bottom: 8px;      
        display: block;    
    }
    @media print {      
        body * {        
            visibility: hidden;      
        }      
        .certificates, .certificates * {        
            visibility: visible;      
        }      
        .certificates {        
            position: absolute;        
            left: 0;        
            top: 0;      
        }      
        .certificate-actions {        
            display: none;      
        }    
    }  
  </style>
</head>
<body>
  <h1>ğŸ“„ Ù†Ø¸Ø§Ù… Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª</h1>
  <div class="tabs">
    <button class="active" onclick="showTab('courseTab', event)">â• Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙˆØ±Ø©</button>
    <button onclick="showTab('uploadTab', event)">ğŸ“¥ Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</button>
    <button onclick="showTab('exportTab', event)">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª</button>
  </div>

  <div id="courseTab" class="tab-content active">
    <h2>Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙˆØ±Ø©</h2>
    <input type="text" id="courseName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©" />
    <input type="date" id="startDate" />
    <input type="date" id="endDate" />
    <button class="submit" onclick="saveCourse()">Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙˆØ±Ø©</button>

    <h2>Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ©</h2>
    <table id="coursesTable">
      <thead>
        <tr>
          <th>Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©</th>
          <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
          <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</th>
          <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody>
        </tbody>
    </table>
  </div>

  <div id="uploadTab" class="tab-content">
    <h2>Ø±ÙØ¹ Ù…Ù„Ù Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</h2>
    <label for="courseSelect">Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø·Ø¨Ø§Ø¹Ø© Ø´Ù‡Ø§Ø¯Ø§ØªÙ‡Ø§:</label>
    <select id="courseSelect">
      <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±Ø© --</option>
    </select>
    <input type="file" id="excelFile" accept=".xlsx" />
  </div>

  <div id="exportTab" class="tab-content">
    <h2>Ø¹Ø±Ø¶ ÙˆØªØµØ¯ÙŠØ± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª</h2>
    <button class="export-btn" onclick="exportCertificatesZip()">ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª ÙÙŠ Ù…Ù„Ù Ù…Ø¶ØºÙˆØ· ZIP</button>
    <button class="send-all-emails-btn" onclick="sendAllCertificatesByEmail()">Ø¥Ø±Ø³Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</button>
    <div class="certificates" id="certContainer"></div>
  </div>

<script>
  let courses = [];
  let participantsData = []; // Ø³ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ { name: 'Ø§Ø³Ù…', email: 'Ø§ÙŠÙ…ÙŠÙ„@Ù…Ø«Ø§Ù„.com' }
  let selectedCourseIndex = null;

  function showTab(tabId, event) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');

    document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
    event.currentTarget.classList.add('active');
  }

  function saveCourse() {
    const name = document.getElementById('courseName').value.trim();
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    if (!name || !start || !end) {
      alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙˆØ±Ø©');
      return;
    }
    const existsIndex = courses.findIndex(c => c.name === name);
    if (existsIndex >= 0) {
      courses[existsIndex] = { name, start, end };
      alert('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!');
    } else {
      courses.push({ name, start, end });
      alert('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!');
    }
    renderCoursesTable();
    populateCourseSelect();
    clearCourseInputs();
  }

  function renderCoursesTable() {
    const tbody = document.querySelector('#coursesTable tbody');
    tbody.innerHTML = '';
    courses.forEach((course, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${course.name}</td>
        <td>${formatDate(course.start)}</td>
        <td>${formatDate(course.end)}</td>
        <td>
          <button class="edit-btn" onclick="editCourse(${index})">ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="delete-btn" onclick="deleteCourse(${index})" style="
            background-color: #dc3545; 
            color: white; 
            border: none; 
            padding: 6px 14px; 
            border-radius: 6px; 
            cursor: pointer;
            font-weight: bold;
            margin-left: 6px;
          ">Ø­Ø°Ù</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function editCourse(index) {
    const course = courses[index];
    document.getElementById('courseName').value = course.name;
    document.getElementById('startDate').value = course.start;
    document.getElementById('endDate').value = course.end;
  }

  function deleteCourse(index) {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø©ØŸ')) {
      courses.splice(index, 1);
      renderCoursesTable();
      populateCourseSelect();
      clearCourseInputs();
      alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!');
    }
  }

  function clearCourseInputs() {
    document.getElementById('courseName').value = '';
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
  }

  function populateCourseSelect() {
    const select = document.getElementById('courseSelect');
    select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±Ø© --</option>';
    courses.forEach((course, idx) => {
      const option = document.createElement('option');
      option.value = idx;
      option.textContent = course.name;
      select.appendChild(option);
    });
  }

  document.getElementById('excelFile').addEventListener('change', function(event){
    const file = event.target.files[0];
    if (!file) return;

    const courseSelect = document.getElementById('courseSelect');
    selectedCourseIndex = courseSelect.value;

    if (selectedCourseIndex === '') {
      alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø·Ø¨Ø§Ø¹Ø© Ø´Ù‡Ø§Ø¯Ø§ØªÙ‡Ø§ Ø£ÙˆÙ„Ø§Ù‹');
      this.value = '';
      return;
    }

    const reader = new FileReader();
    reader.onload = function(e){
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type:'array'});
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      // ØªØºÙŠÙŠØ±: Ù‚Ø±Ø§Ø¡Ø© Ø¹Ù…ÙˆØ¯ÙŠÙ†: Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„ ÙˆØ§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ)
      const json = XLSX.utils.sheet_to_json(sheet, {header:1});

      participantsData = [];
      for(let i=1; i<json.length; i++) {
        const row = json[i];
        if(row.length > 0 && row[0]) {
          // Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„ Ù‡Ùˆ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ Ù‡Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
          participantsData.push({ name: row[0], email: row[1] ? String(row[1]).trim() : '' }); // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§)
        }
      }
      alert(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${participantsData.length} Ø§Ø³Ù…Ø§Ù‹`);
      renderCertificates();
      document.querySelector('.tabs button:nth-child(3)').click();
    }
    reader.readAsArrayBuffer(file);
  });

  function renderCertificates() {
    const container = document.getElementById('certContainer');
    container.innerHTML = '';

    if (selectedCourseIndex === null || selectedCourseIndex === '') {
      container.innerHTML = '<p>ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¯ÙˆØ±Ø© ÙˆØ±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø£ÙˆÙ„Ø§Ù‹.</p>';
      return;
    }

    const course = courses[selectedCourseIndex];
    if (!course) {
      container.innerHTML = '<p>Ø§Ù„Ø¯ÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.</p>';
      return;
    }

    participantsData.forEach((participant, index) => {
      const div = document.createElement('div');
      // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø§ÙˆÙŠØ© Ù„Ù„Ø´Ù‡Ø§Ø¯Ø© Ù†ÙØ³Ù‡Ø§
      const certificateContent = document.createElement('div');
      certificateContent.className = 'certificate';

      certificateContent.innerHTML = `
        <div class="certificate-header">
          <h1>Ø´Ù‡Ø§Ø¯Ø© Ø´ÙƒØ± ÙˆØªÙ‚Ø¯ÙŠØ±</h1>
        </div>
        <div class="certificate-body">
          <p>ØªÙÙ…Ù†Ø­ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¥Ù„Ù‰</p>
          <h2>${participant.name}</h2>
          <p>Ù„Ù…Ø´Ø§Ø±ÙƒØªÙ‡ Ø§Ù„ÙØ¹Ø§Ù„Ø© ÙÙŠ Ø¯ÙˆØ±Ø©</p>
          <h2>${course.name}</h2>
          <p>Ù…Ù† ØªØ§Ø±ÙŠØ®: ${formatDate(course.start)} Ø¥Ù„Ù‰: ${formatDate(course.end)}</p>
        </div>
        <div class="footer">
          <span>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${formatDate(new Date().toISOString().split('T')[0])}</span>
          <span>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
        </div>
      `;
      div.appendChild(certificateContent);

      // Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø£Ø³ÙÙ„ ÙƒÙ„ Ø´Ù‡Ø§Ø¯Ø©
      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'certificate-actions';
      actionsDiv.innerHTML = `
        <button class="send-email-btn" onclick="sendCertificateEmail(${index})">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</button>
        <button class="print-btn" onclick="printCertificate(${index})">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</button>
      `;
      div.appendChild(actionsDiv);

      container.appendChild(div);
    });
  }

  async function sendCertificateEmail(index) {
    const participant = participantsData[index];
    const course = courses[selectedCourseIndex];

    if (!participant || !course) {
      alert('Ø®Ø·Ø£: Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¯Ø±Ø¨ Ø£Ùˆ Ø§Ù„Ø¯ÙˆØ±Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©.');
      return;
    }

    if (!participant.email || !validateEmail(participant.email)) {
      const emailPrompt = prompt(`Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…ØªØ¯Ø±Ø¨ "${participant.name}":`, participant.email || '');
      if (emailPrompt === null || !validateEmail(emailPrompt)) {
        alert('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­.');
        return false; // Return false if email is not valid or prompt is cancelled
      }
      participant.email = emailPrompt; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…ØªØ¯Ø±Ø¨
    }

    const templateParams = {
      to_name: participant.name,
      to_email: participant.email,
      course_name: course.name,
      start_date: formatDate(course.start),
      end_date: formatDate(course.end),
      issue_date: formatDate(new Date().toISOString().split('T')[0]),
      // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù‡Ù†Ø§ Ù„ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙÙŠ Ù‚Ø§Ù„Ø¨ EmailJS Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
    };
    
    // ØªÙ… ØªØ­Ø¯ÙŠØ« Service ID Ùˆ Template ID Ø§Ù„Ø®Ø§ØµÙŠÙ† Ø¨Ùƒ Ù‡Ù†Ø§
    const serviceID = 'service_42kt09l';    
    const templateID = 'template_g3rd0ao';  

    try {
      const response = await emailjs.send(serviceID, templateID, templateParams);
      console.log('SUCCESS!', response.status, response.text);
      // alert(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¥Ù„Ù‰ ${participant.name} Ø¨Ù†Ø¬Ø§Ø­!`); // Ù„Ø§ Ù†Ø±ÙŠØ¯ Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„ÙƒÙ„ Ø¥ÙŠÙ…ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ
      return true; // Return true on success
    } catch (error) {
      console.log('FAILED...', error);
      alert(`ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¥Ù„Ù‰ ${participant.name}. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰. Ø®Ø·Ø£: ${error.text}`);
      return false; // Return false on failure
    }
  }

  // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª  
  async function sendAllCertificatesByEmail() {    
    if (participantsData.length === 0) {      
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ù‡Ø§Ø¯Ø§Øª Ù„Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§. ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø£ÙˆÙ„Ø§Ù‹.');      
        return;    
    }

    const confirmed = confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ ${participantsData.length} Ø´Ù‡Ø§Ø¯Ø© Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØŸ`);    
    if (!confirmed) {      
        return;    
    }

    let successCount = 0;    
    let failCount = 0;    
    const missingEmails = [];

    // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯    
    const sendAllBtn = document.querySelector('.send-all-emails-btn');    
    sendAllBtn.disabled = true;    
    sendAllBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„... Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±';

    for (let i = 0; i < participantsData.length; i++) {      
        const participant = participantsData[i];      
        if (!participant.email || !validateEmail(participant.email)) {        
            missingEmails.push(participant.name);        
            failCount++;        
            continue; // ØªØ®Ø·ÙŠ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡Ù… Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØµØ§Ù„Ø­      
        }

        const success = await sendCertificateEmail(i); // Ø§Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„ÙØ±Ø¯ÙŠØ©      
        if (success) {        
            successCount++;      
        } else {        
            failCount++;      
        }      
        // ÙŠÙ…ÙƒÙ†Ùƒ Ù‡Ù†Ø§ ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø¯Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)      
        console.log(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ${successCount} / ${participantsData.length} Ø´Ù‡Ø§Ø¯Ø©.`);    
    }

    sendAllBtn.disabled = false; // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±    
    sendAllBtn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„';

    let resultMessage = `Ø¹Ù…Ù„ÙŠØ© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù†ØªÙ‡Øª:\n`;    
    resultMessage += `ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù€ ${successCount} Ù…ØªØ¯Ø±Ø¨.\n`;    
    resultMessage += `ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù€ ${failCount} Ù…ØªØ¯Ø±Ø¨.\n`;

    if (missingEmails.length > 0) {      
        resultMessage += `Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø´Ù‡Ø§Ø¯Ø§Øª Ù„Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ø§Ù„ØªØ§Ù„ÙŠØ© Ø£Ø³Ù…Ø§Ø¦Ù‡Ù… Ø¨Ø³Ø¨Ø¨ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØµØ§Ù„Ø­:\n- ${missingEmails.join('\n- ')}\n`;      
        resultMessage += `ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ø´Ù‡Ø§Ø¯Ø§ØªÙ‡Ù… Ø¨Ø´ÙƒÙ„ ÙØ±Ø¯ÙŠ Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙŠØ¯ÙˆÙŠØ§Ù‹.`;    
    }
    alert(resultMessage);  
}

  function validateEmail(email) {    
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;    
    return re.test(String(email).toLowerCase());  
}

  function printCertificate(index) {    
    const certificateElement = document.querySelectorAll('.certificate')[index];    
    if (certificateElement) {      
        const printWindow = window.open('', '', 'height=600,width=800');      
        printWindow.document.write('<html><head><title>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</title>');      
        printWindow.document.write('<style>');      
        printWindow.document.write(`        
            body { font-family: 'Segoe UI', sans-serif; direction: rtl; margin: 0; padding: 0; }        
            .certificate {            
                width: 780px;            
                height: 480px;            
                border: 4px solid #333;            
                background: white;            
                margin: 10px auto;            
                padding: 30px;            
                text-align: center;            
                position: relative;            
                box-sizing: border-box;            
                display: flex;            
                flex-direction: column;            
                justify-content: space-between;        
            }        
            .certificate-header h1 { font-size: 28px; margin-bottom: 10px; }        
            .certificate-body { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }        
            .certificate-body h2 { font-size: 24px; margin: 10px 0; }        
            .certificate-body p { font-size: 18px; margin: 5px 0; }        
            .footer {            
                position: relative;            
                bottom: 0;            
                left: 0;            
                right: 0;            
                display: flex;            
                justify-content: space-between;            
                font-size: 16px;            
                padding-top: 20px;        
            }      
        `);      
        printWindow.document.write('</style></head><body>');      
        printWindow.document.write(certificateElement.outerHTML);      
        printWindow.document.write('</body></html>');      
        printWindow.document.close();      
        printWindow.focus();      
        printWindow.print();    
    }  
}

  function formatDate(dateStr) {    
    if (!dateStr) return '';    
    const d = new Date(dateStr);    
    if (isNaN(d)) return dateStr;    
    return d.toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });  
}

  function exportCertificatesZip() {    
    if (participantsData.length === 0) {      
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ù‡Ø§Ø¯Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§. ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø£ÙˆÙ„Ø§Ù‹.');      
        return;    
    }

    const course = courses[selectedCourseIndex];    
    if (!course) {      
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¯ÙˆØ±Ø© ØµØ­ÙŠØ­Ø©.');      
        return;
    }

    const zip = new JSZip();

    participantsData.forEach(participant => {      
        const certificateHtml = `        
            <!DOCTYPE html>        
            <html lang="ar">        
            <head>          
                <meta charset="UTF-8">          
                <title>Ø´Ù‡Ø§Ø¯Ø© - ${participant.name}</title>          
                <style>            
                    body { font-family: 'Segoe UI', sans-serif; direction: rtl; margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f4f4f4; }            
                    .certificate {              
                        width: 800px;              
                        height: 500px;              
                        border: 4px solid #333;              
                        background: white;              
                        padding: 30px;              
                        text-align: center;              
                        position: relative;              
                        box-sizing: border-box;              
                        display: flex;              
                        flex-direction: column;              
                        justify-content: space-between;              
                        box-shadow: 0 8px 20px rgba(0,0,0,0.1);            
                    }            
                    .certificate-header h1 { font-size: 28px; margin-bottom: 10px; }            
                    .certificate-body { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }            
                    .certificate-body h2 { font-size: 24px; margin: 10px 0; }            
                    .certificate-body p { font-size: 18px; margin: 5px 0; }            
                    .footer {              
                        position: relative;              
                        bottom: 0;              
                        left: 0;              
                        right: 0;              
                        display: flex;              
                        justify-content: space-between;              
                        font-size: 16px;              
                        padding-top: 20px;            
                    }          
                </style>        
            </head>        
            <body>          
                <div class="certificate">            
                    <div class="certificate-header">              
                        <h1>Ø´Ù‡Ø§Ø¯Ø© Ø´ÙƒØ± ÙˆØªÙ‚Ø¯ÙŠØ±</h1>            
                    </div>            
                    <div class="certificate-body">              
                        <p>ØªÙÙ…Ù†Ø­ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¥Ù„Ù‰</p>              
                        <h2>${participant.name}</h2>              
                        <p>Ù„Ù…Ø´Ø§Ø±ÙƒØªÙ‡ Ø§Ù„ÙØ¹Ø§Ù„Ø© ÙÙŠ Ø¯ÙˆØ±Ø©</p>              
                        <h2>${course.name}</h2>              
                        <p>Ù…Ù† ØªØ§Ø±ÙŠØ®: ${formatDate(course.start)} Ø¥Ù„Ù‰: ${formatDate(course.end)}</p>            
                    </div>            
                    <div class="footer">              
                        <span>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${formatDate(new Date().toISOString().split('T')[0])}</span>              
                        <span>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>            
                    </div>          
                </div>        
            </body>        
            </html>      
        `;      
        zip.file(`${participant.name}.html`, certificateHtml);    
    });

    zip.generateAsync({type:"blob"}).then(function(content) {      
        saveAs(content, `${course.name}_Ø´Ù‡Ø§Ø¯Ø§Øª.zip`);    
    });  
  }
</script>
</body>
</html>
