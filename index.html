<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>نظام إصدار الشهادات</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script type="text/javascript">
    (function() {
      // تم تحديث Public Key الخاص بك هنا
      emailjs.init({
        publicKey: "pyfwfXQk621NyRfEn", 
      });
    })();
  </script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      direction: rtl;
      padding: 40px;
      background-color: #f4f4f4;
    }
    h1 {
      text-align: center;
    }
    .tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
      flex-wrap: nowrap;
    }
    .tabs button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 25px;
      font-size: 16px;
      border-radius: 10px 10px 0 0;
      cursor: pointer;
      flex: 1;
      max-width: 200px;
      white-space: nowrap;
      transition: background-color 0.3s;
    }
    .tabs button.active {
      background: #0056b3;
    }
    .tab-content {
      display: none;
      background: #fff;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      max-width: 800px;
      margin: auto;
    }
    .tab-content.active {
      display: block;
    }
    input[type="file"], button.submit, button.export-btn, button.send-all-emails-btn {
      margin: 20px 5px; /* Adjust margin for multiple buttons */
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 8px;
      border: none;
    }
    button.submit {
      background: #28a745;
      color: white;
    }
    button.export-btn {
      background: #007bff;
      color: white;
    }
    button.send-all-emails-btn { /* Style for the new button */        
        background-color: #6f42c1; /* Purple color */        
        color: white;    
    }
    button.send-all-emails-btn:hover {        
        background-color: #5a3597;    
    }
    .certificates {      
        display: flex;      
        flex-direction: column;      
        align-items: center;    
    }
    .certificate {      
        width: 800px;      
        height: 500px;      
        border: 4px solid #333;      
        background: white;      
        margin: 20px 0;      
        padding: 30px;      
        text-align: center;      
        position: relative;      
        box-sizing: border-box;      
        display: flex;      
        flex-direction: column;      
        justify-content: space-between;    
    }
    .certificate-header h1 {      
        font-size: 28px;      
        margin-bottom: 10px;    
    }
    .certificate-body {        
        flex-grow: 1;        
        display: flex;        
        flex-direction: column;        
        justify-content: center;        
        align-items: center;    
    }
    .certificate-body h2 {      
        font-size: 24px;      
        margin: 10px 0;    
    }
    .certificate-body p {      
        font-size: 18px;      
        margin: 5px 0;    
    }
    .footer {      
        position: relative;      
        bottom: 0;      
        left: 0;      
        right: 0;      
        display: flex;      
        justify-content: space-between;      
        font-size: 16px;      
        padding-top: 20px;    
    }
    .certificate-actions {      
        text-align: center;      
        margin-top: 10px;    
    }
    .certificate-actions button {      
        padding: 8px 15px;      
        margin: 5px;      
        border-radius: 6px;      
        border: none;      
        cursor: pointer;      
        font-size: 15px;      
        transition: background-color 0.3s;    
    }
    .certificate-actions .send-email-btn {      
        background-color: #ffc107;      
        color: #212529;    
    }
    .certificate-actions .send-email-btn:hover {      
        background-color: #e0a800;    
    }
    .certificate-actions .print-btn {        
        background-color: #17a2b8; /* Info blue color */        
        color: white;    
    }
    .certificate-actions .print-btn:hover {        
        background-color: #138496;    
    }
    table {      
        width: 100%;      
        border-collapse: collapse;      
        margin-top: 20px;    
    }
    table, th, td {      
        border: 2px solid #007bff;    
    }
    th, td {      
        padding: 10px;      
        text-align: center;      
        font-size: 16px;    
    }
    th {      
        background-color: #007bff;      
        color: white;    
    }
    button.edit-btn {      
        background-color: #ffc107;      
        border: none;      
        padding: 6px 14px;      
        border-radius: 6px;      
        cursor: pointer;      
        color: #212529;      
        font-weight: bold;      
        transition: background-color 0.3s;    
    }
    button.edit-btn:hover {      
        background-color: #e0a800;    
    }
    #courseSelect {      
        width: 100%;      
        max-width: 400px;      
        padding: 10px 15px;      
        font-size: 16px;      
        border: 2px solid #007bff;      
        border-radius: 8px;      
        outline: none;      
        box-sizing: border-box;      
        margin-bottom: 20px;      
        appearance: none;      
        background-color: #fff;      
        cursor: pointer;    
    }
    #uploadTab label[for="courseSelect"] {      
        font-weight: bold;      
        margin-bottom: 8px;      
        display: block;    
    }
    @media print {      
        body * {        
            visibility: hidden;      
        }      
        .certificates, .certificates * {        
            visibility: visible;      
        }      
        .certificates {        
            position: absolute;        
            left: 0;        
            top: 0;      
        }      
        .certificate-actions {        
            display: none;      
        }    
    }  
  </style>
</head>
<body>
  <h1>📄 نظام إصدار الشهادات</h1>
  <div class="tabs">
    <button class="active" onclick="showTab('courseTab', event)">➕ إضافة بيانات الدورة</button>
    <button onclick="showTab('uploadTab', event)">📥 رفع ملف الأسماء</button>
    <button onclick="showTab('exportTab', event)">📤 تصدير الشهادات</button>
  </div>

  <div id="courseTab" class="tab-content active">
    <h2>إضافة بيانات الدورة</h2>
    <input type="text" id="courseName" placeholder="اسم الدورة" />
    <input type="date" id="startDate" />
    <input type="date" id="endDate" />
    <button class="submit" onclick="saveCourse()">حفظ بيانات الدورة</button>

    <h2>الدورات المضافة</h2>
    <table id="coursesTable">
      <thead>
        <tr>
          <th>اسم الدورة</th>
          <th>تاريخ البداية</th>
          <th>تاريخ النهاية</th>
          <th>الإجراءات</th>
        </tr>
      </thead>
      <tbody>
        </tbody>
    </table>
  </div>

  <div id="uploadTab" class="tab-content">
    <h2>رفع ملف أسماء المشتركين</h2>
    <label for="courseSelect">اختر الدورة التي تريد طباعة شهاداتها:</label>
    <select id="courseSelect">
      <option value="">-- اختر الدورة --</option>
    </select>
    <input type="file" id="excelFile" accept=".xlsx" />
  </div>

  <div id="exportTab" class="tab-content">
    <h2>عرض وتصدير الشهادات</h2>
    <button class="export-btn" onclick="exportCertificatesZip()">تصدير جميع الشهادات في ملف مضغوط ZIP</button>
    <button class="send-all-emails-btn" onclick="sendAllCertificatesByEmail()">إرسال جميع الشهادات بالإيميل</button>
    <div class="certificates" id="certContainer"></div>
  </div>

<script>
  let courses = [];
  let participantsData = []; // سيحتوي على { name: 'اسم', email: 'ايميل@مثال.com' }
  let selectedCourseIndex = null;

  function showTab(tabId, event) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');

    document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
    event.currentTarget.classList.add('active');
  }

  function saveCourse() {
    const name = document.getElementById('courseName').value.trim();
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    if (!name || !start || !end) {
      alert('يرجى ملء جميع حقول بيانات الدورة');
      return;
    }
    const existsIndex = courses.findIndex(c => c.name === name);
    if (existsIndex >= 0) {
      courses[existsIndex] = { name, start, end };
      alert('تم تعديل بيانات الدورة بنجاح!');
    } else {
      courses.push({ name, start, end });
      alert('تم حفظ بيانات الدورة بنجاح!');
    }
    renderCoursesTable();
    populateCourseSelect();
    clearCourseInputs();
  }

  function renderCoursesTable() {
    const tbody = document.querySelector('#coursesTable tbody');
    tbody.innerHTML = '';
    courses.forEach((course, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${course.name}</td>
        <td>${formatDate(course.start)}</td>
        <td>${formatDate(course.end)}</td>
        <td>
          <button class="edit-btn" onclick="editCourse(${index})">تعديل</button>
          <button class="delete-btn" onclick="deleteCourse(${index})" style="
            background-color: #dc3545; 
            color: white; 
            border: none; 
            padding: 6px 14px; 
            border-radius: 6px; 
            cursor: pointer;
            font-weight: bold;
            margin-left: 6px;
          ">حذف</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function editCourse(index) {
    const course = courses[index];
    document.getElementById('courseName').value = course.name;
    document.getElementById('startDate').value = course.start;
    document.getElementById('endDate').value = course.end;
  }

  function deleteCourse(index) {
    if (confirm('هل أنت متأكد من حذف هذه الدورة؟')) {
      courses.splice(index, 1);
      renderCoursesTable();
      populateCourseSelect();
      clearCourseInputs();
      alert('تم حذف الدورة بنجاح!');
    }
  }

  function clearCourseInputs() {
    document.getElementById('courseName').value = '';
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
  }

  function populateCourseSelect() {
    const select = document.getElementById('courseSelect');
    select.innerHTML = '<option value="">-- اختر الدورة --</option>';
    courses.forEach((course, idx) => {
      const option = document.createElement('option');
      option.value = idx;
      option.textContent = course.name;
      select.appendChild(option);
    });
  }

  document.getElementById('excelFile').addEventListener('change', function(event){
    const file = event.target.files[0];
    if (!file) return;

    const courseSelect = document.getElementById('courseSelect');
    selectedCourseIndex = courseSelect.value;

    if (selectedCourseIndex === '') {
      alert('يرجى اختيار الدورة التي تريد طباعة شهاداتها أولاً');
      this.value = '';
      return;
    }

    const reader = new FileReader();
    reader.onload = function(e){
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type:'array'});
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      // تغيير: قراءة عمودين: الاسم والبريد الإلكتروني (العمود الأول والعمود الثاني)
      const json = XLSX.utils.sheet_to_json(sheet, {header:1});

      participantsData = [];
      for(let i=1; i<json.length; i++) {
        const row = json[i];
        if(row.length > 0 && row[0]) {
          // نفترض أن العمود الأول هو الاسم والعمود الثاني هو البريد الإلكتروني
          participantsData.push({ name: row[0], email: row[1] ? String(row[1]).trim() : '' }); // إضافة البريد الإلكتروني (إذا كان موجودًا)
        }
      }
      alert(`تم تحميل ${participantsData.length} اسماً`);
      renderCertificates();
      document.querySelector('.tabs button:nth-child(3)').click();
    }
    reader.readAsArrayBuffer(file);
  });

  function renderCertificates() {
    const container = document.getElementById('certContainer');
    container.innerHTML = '';

    if (selectedCourseIndex === null || selectedCourseIndex === '') {
      container.innerHTML = '<p>يرجى اختيار دورة ورفع ملف الأسماء أولاً.</p>';
      return;
    }

    const course = courses[selectedCourseIndex];
    if (!course) {
      container.innerHTML = '<p>الدورة غير موجودة.</p>';
      return;
    }

    participantsData.forEach((participant, index) => {
      const div = document.createElement('div');
      // إنشاء حاوية للشهادة نفسها
      const certificateContent = document.createElement('div');
      certificateContent.className = 'certificate';

      certificateContent.innerHTML = `
        <div class="certificate-header">
          <h1>شهادة شكر وتقدير</h1>
        </div>
        <div class="certificate-body">
          <p>تُمنح هذه الشهادة إلى</p>
          <h2>${participant.name}</h2>
          <p>لمشاركته الفعالة في دورة</p>
          <h2>${course.name}</h2>
          <p>من تاريخ: ${formatDate(course.start)} إلى: ${formatDate(course.end)}</p>
        </div>
        <div class="footer">
          <span>التاريخ: ${formatDate(new Date().toISOString().split('T')[0])}</span>
          <span>الإدارة</span>
        </div>
      `;
      div.appendChild(certificateContent);

      // إضافة أزرار الإجراءات أسفل كل شهادة
      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'certificate-actions';
      actionsDiv.innerHTML = `
        <button class="send-email-btn" onclick="sendCertificateEmail(${index})">إرسال الشهادة بالإيميل</button>
        <button class="print-btn" onclick="printCertificate(${index})">طباعة الشهادة</button>
      `;
      div.appendChild(actionsDiv);

      container.appendChild(div);
    });
  }

  async function sendCertificateEmail(index) {
    const participant = participantsData[index];
    const course = courses[selectedCourseIndex];

    if (!participant || !course) {
      alert('خطأ: بيانات المتدرب أو الدورة غير متوفرة.');
      return;
    }

    if (!participant.email || !validateEmail(participant.email)) {
      const emailPrompt = prompt(`الرجاء إدخال البريد الإلكتروني للمتدرب "${participant.name}":`, participant.email || '');
      if (emailPrompt === null || !validateEmail(emailPrompt)) {
        alert('تم إلغاء الإرسال أو البريد الإلكتروني غير صالح.');
        return false; // Return false if email is not valid or prompt is cancelled
      }
      participant.email = emailPrompt; // تحديث البريد الإلكتروني للمتدرب
    }

    const templateParams = {
      to_name: participant.name,
      to_email: participant.email,
      course_name: course.name,
      start_date: formatDate(course.start),
      end_date: formatDate(course.end),
      issue_date: formatDate(new Date().toISOString().split('T')[0]),
      // يمكنك إضافة المزيد من المتغيرات هنا ليتم استخدامها في قالب EmailJS الخاص بك
    };
    
    // تم تحديث Service ID و Template ID الخاصين بك هنا
    const serviceID = 'service_42kt09l';    
    const templateID = 'template_g3rd0ao';  

    try {
      const response = await emailjs.send(serviceID, templateID, templateParams);
      console.log('SUCCESS!', response.status, response.text);
      // alert(`تم إرسال الشهادة إلى ${participant.name} بنجاح!`); // لا نريد هذه الرسائل المنبثقة لكل إيميل في الإرسال الجماعي
      return true; // Return true on success
    } catch (error) {
      console.log('FAILED...', error);
      alert(`فشل إرسال الشهادة إلى ${participant.name}. الرجاء التحقق من الإعدادات والمحاولة مرة أخرى. خطأ: ${error.text}`);
      return false; // Return false on failure
    }
  }

  // دالة جديدة لإرسال جميع الشهادات  
  async function sendAllCertificatesByEmail() {    
    if (participantsData.length === 0) {      
        alert('لا توجد شهادات لإرسالها. يرجى رفع ملف الأسماء أولاً.');      
        return;    
    }

    const confirmed = confirm(`هل أنت متأكد من إرسال ${participantsData.length} شهادة عبر البريد الإلكتروني؟`);    
    if (!confirmed) {      
        return;    
    }

    let successCount = 0;    
    let failCount = 0;    
    const missingEmails = [];

    // تعطيل الزر أثناء الإرسال لمنع النقر المتعدد    
    const sendAllBtn = document.querySelector('.send-all-emails-btn');    
    sendAllBtn.disabled = true;    
    sendAllBtn.textContent = 'جاري الإرسال... الرجاء الانتظار';

    for (let i = 0; i < participantsData.length; i++) {      
        const participant = participantsData[i];      
        if (!participant.email || !validateEmail(participant.email)) {        
            missingEmails.push(participant.name);        
            failCount++;        
            continue; // تخطي المتدربين الذين ليس لديهم بريد إلكتروني صالح      
        }

        const success = await sendCertificateEmail(i); // استخدم نفس الدالة الفردية      
        if (success) {        
            successCount++;      
        } else {        
            failCount++;      
        }      
        // يمكنك هنا تحديث واجهة المستخدم لعرض التقدم (اختياري)      
        console.log(`تم إرسال ${successCount} / ${participantsData.length} شهادة.`);    
    }

    sendAllBtn.disabled = false; // إعادة تفعيل الزر    
    sendAllBtn.textContent = 'إرسال جميع الشهادات بالإيميل';

    let resultMessage = `عملية إرسال الشهادات انتهت:\n`;    
    resultMessage += `تم الإرسال بنجاح لـ ${successCount} متدرب.\n`;    
    resultMessage += `فشل الإرسال لـ ${failCount} متدرب.\n`;

    if (missingEmails.length > 0) {      
        resultMessage += `لم يتم إرسال شهادات للمتدربين التالية أسمائهم بسبب عدم وجود بريد إلكتروني صالح:\n- ${missingEmails.join('\n- ')}\n`;      
        resultMessage += `يمكنك إرسال شهاداتهم بشكل فردي لإدخال البريد الإلكتروني يدوياً.`;    
    }
    alert(resultMessage);  
}

  function validateEmail(email) {    
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;    
    return re.test(String(email).toLowerCase());  
}

  function printCertificate(index) {    
    const certificateElement = document.querySelectorAll('.certificate')[index];    
    if (certificateElement) {      
        const printWindow = window.open('', '', 'height=600,width=800');      
        printWindow.document.write('<html><head><title>طباعة الشهادة</title>');      
        printWindow.document.write('<style>');      
        printWindow.document.write(`        
            body { font-family: 'Segoe UI', sans-serif; direction: rtl; margin: 0; padding: 0; }        
            .certificate {            
                width: 780px;            
                height: 480px;            
                border: 4px solid #333;            
                background: white;            
                margin: 10px auto;            
                padding: 30px;            
                text-align: center;            
                position: relative;            
                box-sizing: border-box;            
                display: flex;            
                flex-direction: column;            
                justify-content: space-between;        
            }        
            .certificate-header h1 { font-size: 28px; margin-bottom: 10px; }        
            .certificate-body { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }        
            .certificate-body h2 { font-size: 24px; margin: 10px 0; }        
            .certificate-body p { font-size: 18px; margin: 5px 0; }        
            .footer {            
                position: relative;            
                bottom: 0;            
                left: 0;            
                right: 0;            
                display: flex;            
                justify-content: space-between;            
                font-size: 16px;            
                padding-top: 20px;        
            }      
        `);      
        printWindow.document.write('</style></head><body>');      
        printWindow.document.write(certificateElement.outerHTML);      
        printWindow.document.write('</body></html>');      
        printWindow.document.close();      
        printWindow.focus();      
        printWindow.print();    
    }  
}

  function formatDate(dateStr) {    
    if (!dateStr) return '';    
    const d = new Date(dateStr);    
    if (isNaN(d)) return dateStr;    
    return d.toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });  
}

  function exportCertificatesZip() {    
    if (participantsData.length === 0) {      
        alert('لا توجد شهادات لتصديرها. يرجى رفع ملف الأسماء أولاً.');      
        return;    
    }

    const course = courses[selectedCourseIndex];    
    if (!course) {      
        alert('يرجى اختيار دورة صحيحة.');      
        return;
    }

    const zip = new JSZip();

    participantsData.forEach(participant => {      
        const certificateHtml = `        
            <!DOCTYPE html>        
            <html lang="ar">        
            <head>          
                <meta charset="UTF-8">          
                <title>شهادة - ${participant.name}</title>          
                <style>            
                    body { font-family: 'Segoe UI', sans-serif; direction: rtl; margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f4f4f4; }            
                    .certificate {              
                        width: 800px;              
                        height: 500px;              
                        border: 4px solid #333;              
                        background: white;              
                        padding: 30px;              
                        text-align: center;              
                        position: relative;              
                        box-sizing: border-box;              
                        display: flex;              
                        flex-direction: column;              
                        justify-content: space-between;              
                        box-shadow: 0 8px 20px rgba(0,0,0,0.1);            
                    }            
                    .certificate-header h1 { font-size: 28px; margin-bottom: 10px; }            
                    .certificate-body { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }            
                    .certificate-body h2 { font-size: 24px; margin: 10px 0; }            
                    .certificate-body p { font-size: 18px; margin: 5px 0; }            
                    .footer {              
                        position: relative;              
                        bottom: 0;              
                        left: 0;              
                        right: 0;              
                        display: flex;              
                        justify-content: space-between;              
                        font-size: 16px;              
                        padding-top: 20px;            
                    }          
                </style>        
            </head>        
            <body>          
                <div class="certificate">            
                    <div class="certificate-header">              
                        <h1>شهادة شكر وتقدير</h1>            
                    </div>            
                    <div class="certificate-body">              
                        <p>تُمنح هذه الشهادة إلى</p>              
                        <h2>${participant.name}</h2>              
                        <p>لمشاركته الفعالة في دورة</p>              
                        <h2>${course.name}</h2>              
                        <p>من تاريخ: ${formatDate(course.start)} إلى: ${formatDate(course.end)}</p>            
                    </div>            
                    <div class="footer">              
                        <span>التاريخ: ${formatDate(new Date().toISOString().split('T')[0])}</span>              
                        <span>الإدارة</span>            
                    </div>          
                </div>        
            </body>        
            </html>      
        `;      
        zip.file(`${participant.name}.html`, certificateHtml);    
    });

    zip.generateAsync({type:"blob"}).then(function(content) {      
        saveAs(content, `${course.name}_شهادات.zip`);    
    });  
  }
</script>
</body>
</html>
